# vim:syntax=apparmor
# Author: Nibaldo Gonzalez <nibgonz@gmail.com>
# Last change: June 24, 2017

# NOTE: By default, the internet connection is blocked.

#include <tunables/global>

# Directories where videos and data are stored
@{DATA_DIR}=/{home,media,mnt,srv,net,cdrom}

profile mpv /usr/bin/mpv {
	#include <abstractions/audio>
	#include <abstractions/base>
	#include <abstractions/fonts>
	#include <abstractions/kde>
	#include <abstractions/dbus-session-strict>
	#include <abstractions/X>
	#include <abstractions/consoles>
	
	# Block network connection:
	#include <abstractions/block-networking>
	# Allow network connection:
	# #include <abstractions/nameservice>
	
	# Block full access to sensitive data, as passwords and keys.
	# Includes /boot/**, /var/log/** & /etc/apparmor.d/** directories. View in: tunables/confidential.
	#include <abstractions/confidential-deny>
	
	# Only reading access in Home directory, mounted drives and others directories
	@{DATA_DIR}/{,**} r,
	owner /**/{,*} r,
	
	# Block compiled libraries & executables
	audit deny @{DATA_DIR}/** mx,
	audit deny owner /**/* mx,
	
	# Configuration
	owner @{HOME}/.config/mpv/{,**} rwk,
	owner @{HOME}/.config/gnome-mpv/{,**} rwk,
	
	/etc/mpv/{,**} r,
	/etc/udev/udev.conf r,
	/etc/vdpau_wrapper.cfg r,
	
	/sys/**/ r,
	/sys/devices/**/uevent r,
	/sys/devices/system/**/meminfo r,
	/sys/devices/pci[0-9]*/**/{config,device,revision,subsystem_device,subsystem_vendor,vendor} r,
	
	# Device access
	/dev/ati/{,**} r,
	/dev/dri/{,**} r,
	audit deny /dev/{video,audio}* rwlkmx,  # Block cameras & microphones
	
	# Binaries and libraries
	/usr/bin/mpv ixr,
	/usr/bin/{dbus-send,xdg-screensaver,xset} Pixr,
	/bin/{grep,hostname,mv,sed,which} Pixr,
	deny /usr/lib{,64,/*-linux-gnu}/vlc/plugins/plugins.dat{,.*} w,
	
	deny /run/udev/data/{,**} rwklmx,
	audit deny owner /**/*.py* r,  # Block Python imports
	audit deny @{DATA_DIR}/**.py* r,
}
