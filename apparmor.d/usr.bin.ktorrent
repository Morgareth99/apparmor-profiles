# vim:syntax=apparmor
# Author: Nibaldo Gonzalez Salgado
# Last change: February 19, 2017

# NOTE: This profile is only tested on Ubuntu 16.04 & KDE Plasma 5.

#include <tunables/global>

profile ktorrent /usr/bin/ktorrent {
	#include <abstractions/base>
	#include <abstractions/dbus-strict>
	#include <abstractions/dbus-session>
	#include <abstractions/fonts>
	#include <abstractions/nameservice>
	#include <abstractions/X>
	#include <abstractions/kde>
	
	# Block full access to sensitive data such as Thunderbird, Firefox, Opera,
	# Chromium/Chrome passwords, SSH, PGP & Android keys,
	# and /boot/** & /etc/apparmor.d/** directories. View in: tunables/confidential.
	#include <abstractions/confidential-deny>
	
	# Just read/write in the Torrents directory. Modify according to KTorrent configuration.
	@{HOME}/Descargas/Torrents/** rw,
	# Only read .torrent files
	@{HOME}/{,**/}*.torrent r,
	
	@{HOME}/.kde{,4}/share/apps/ktorrent/** rw,
	@{HOME}/.kde{,4}/share/config/ktorrent* rwk,
	@{HOME}/.kde{,4}/share/config/{kde,kio}* rk,  # kdeglobals
	@{HOME}/.kde{,4}/share/config/ktinfowidgetpluginrc r,
	@{HOME}/.kde{,4}/share/config/kcookiejarrc r,
	@{HOME}/.kde{,4}/share/config/breezerc r,
	@{HOME}/.kde{,4}/share/config/{kdeglobals,kdebugrc}*.new rw,
	@{HOME}/.local/share/user-places.xbel{,.*} rw,
	
	deny /run/udev/data/** rwklmx,
	deny /{media,mnt}/** rwklmx,
	
	# Dangerous files
	audit deny owner /**/* m,        # compiled libraries
	audit deny owner /**/*.py* r,  # python imports
	
	/bin/dash Pixr,
	/usr/bin/kdeinit{4,5} rix,
	/usr/bin/kde-open{,5} rix,
	/usr/bin/kde4-config rix,
	/usr/bin/ktorrent rix,
	
	/{,**/} r,  # Read only directories
	
	/usr/share/kde4/apps/ktorrent/{**,} r,
	/usr/share/kde4/config/{,**} r,
	/usr/share/kde4/services/{,**} r,
	/usr/share/kde4/servicetypes/* r,
	/usr/share/GeoIP/* r,
	
	/etc/machine-id r,
	# /etc/fstab r,  # Used, but not essential
	/etc/xdg/{,**} r,
	
	# Allow exec of libexec applications
	/usr/lib{,32,64}/** Pixr,
	
	/proc/*/mounts r,
	/etc/udev/udev.conf r,
	/run/dbus/system_bus_socket rw,
	/sys/devices/system/cpu/{cpu[0-9]*/,}uevent r,	
	/sys/devices/pci[0-9]*/**/uevent r,
	
	# Temp files
	/run/user/[0-9]*/ksocket-*/ktorrent* rwkl,
	/tmp/{,.}ktorrent*.lock rwkl,
	/tmp/kde-*/** rwk,
	/var/tmp/kdecache-*/* rwk,
	
	# For multimedia support
	#/{,var/}run/user/*/pulse/ r,
	#/{run,dev}/shm/pulse-shm* rw,
	#owner /{,var/}run/user/*/pulse/ w,
	#owner /{run,dev}/shm/pulse-shm* k,
	
	signal (send) set=(term) peer=unconfined,
	
	dbus (send)
		bus=system
		path=/org/freedesktop/DBus
		interface=org.freedesktop.DBus
		member=Hello
		peer=(name=org.freedesktop.DBus label=unconfined),
		
	dbus (send)
		bus=system
		path=/org/freedesktop/UDisks2/{block_devices,drives}
		interface=org.freedesktop.DBus.Introspectable
		member=Introspect
		peer=(name=org.freedesktop.UDisks2 label=unconfined),
}
