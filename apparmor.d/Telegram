# vim:syntax=apparmor
# Author: Nibaldo Gonzalez <nibgonz@gmail.com>
# Last change: September 10, 2017

# NOTE: 
#  - Important: Check & change the Telegram binary path and the user downloads directory.
#  - This profile is only tested on Ubuntu 16.04 with KDE Plasma 5 and GNOME 3.
#  - By default, there is only write access to the download directory.

include <tunables/global>

# Download directory:
@{DOWNLOADS_DIR}=@{HOME}/Descargas

profile Telegram /home/*/.TelegramDesktop/bin/{Telegram,Updater} {
	include <abstractions/base>
	include <abstractions/fonts>
	include <abstractions/nameservice>
	include <abstractions/kde>
	include <abstractions/gnome>
	include <abstractions/X>
	include <abstractions/audio>
	include <abstractions/dbus-strict>
	include <abstractions/dbus-session>
	include <abstractions/dbus-accessibility-strict>
	include <abstractions/ibus>
	include <abstractions/flatpak-snap>
	
	# Needed to open links (only for some browsers).
	include <abstractions/open-browser>
	
	# Block full access to sensitive data, as passwords and keys.
	# Includes /boot/**, /var/log/** & /etc/apparmor.d/** directories. View in: tunables/confidential.
	deny @{CONFIDENTIAL_EXCEPT_TELEGRAM} rwklmx,
	
	# Access to Home
	owner @{HOME}/* r,
	owner @{HOME}/[^.]*/ r,
	owner @{HOME}/[^.]*/** r,
	owner @{DOWNLOADS_DIR}/** rw,  # Write only in the downloads directory
	
	# Telegram directory
	owner @{HOME}/.TelegramDesktop/{**,} rwkl,
	owner @{HOME}/.TelegramDesktop/bin/* ixrwk,
	
	# Local configuration
	owner @{HOME}/.config/* r,
	owner @{HOME}/.config/{fontconfig,gtk-[0-9]*,kde.org,menus,pulse,session}/{**,} r,
	owner @{HOME}/.config/gtk-[0-9]*/bookmarks rw,
	owner @{HOME}/.config/dconf/user rw,
	owner /{,var/}run/user/*/dconf/user rw,
	owner @{HOME}/.local/share/icons/{,**} rw,
	deny @{HOME}/.local/share/recently-used.xbel r,
	owner @{HOME}/.kde/share/config/kdeglobals rk,
	owner @{HOME}/.kde/share/kde4/services/*.protocol rw,
	
	owner @{HOME}/.config/kdeglobals rk,
	owner @{HOME}/.cache/icon-cache.kcache rw,
	owner @{HOME}/.cache/ksycoca5_* r,
	owner @{HOME}/.cache/qt_compose_cache_* rw,
	owner @{HOME}/.local/share/RecentDocuments/ r,
	owner @{HOME}/.local/share/RecentDocuments/*.desktop rwl,
	owner @{HOME}/.local/share/RecentDocuments/{,*.desktop}.[a-zA-Z0-9]* rwk,
		
	/usr/share/** r,
	/etc/timezone r,
	/etc/openal/alsoft.conf r,
	/etc/pulse/*.conf r,
	/etc/udev/udev.conf r,
	/etc/xdg/{,**} r,
	deny /etc/xdg/{autostart,systemd}/{,**} rw,
	
	@{PROC}/[0-9]*/cmdline r,
	@{PROC}/[0-9]*/fd/{,**} r,
	/run/systemd/journal/socket rw,
	/run/dbus/system_bus_socket r,
	/run/user/[0-9]*/bus r,
	/sys/dbus/** r,
	/sys/devices/**/uevent r,
	
	# Device access
	/dev/tty* r,
	deny /dev/video* rwmlkx,  # Block cameras
	
	# Binaries & Helpers
	/bin/dash Pixr,
	/usr/bin/pulseaudio Pixr,
	/usr/bin/xdg-open ixr,
	/usr/bin/gnome-open ixr,
	/usr/bin/kde-open{,5} ixr,
	/usr/bin/gvfs-open ixr,
	/usr/bin/kdialog ixr,
	
	# Temp Files
	owner /tmp/** rwk,
	owner /var/tmp/** rw,
	owner /run/user/[0-9]*/*.slave-socket rwk,
	
	# For Networking
	network inet stream,
	network inet6 stream,
	@{PROC}/[0-9]*/net/if_inet6 r,
	@{PROC}/[0-9]*/net/ipv6_route r,
	@{PROC}/[0-9]*/net/dev r,
	@{PROC}/[0-9]*/net/wireless r,
	
	# Block binary execution and mapping of compiled libraries
	audit deny owner /**/* m,
	audit deny @{HOME}/[^.]** mx,
	audit deny /{media,mnt,srv,net}/** mx,
	
	audit deny owner /**/*.py* r,  # Block Python imports
	
	deny /run/udev/data/{,**} rwklmx,
	deny /usr/bin/gconftool-2 x,
	deny /var/cache/fontconfig/ w,
	
	ptrace (trace) peer=unconfined,
	
	dbus (send)
		bus=session
		peer=(name=org.a11y.Bus),
	dbus (receive)
		bus=session
		interface=org.a11y.atspi**,
	dbus (receive, send)
		bus=accessibility,
		
	dbus (send)
		bus=system
		interface=org.freedesktop.DBus.Property.EmitsChangedSignal,
	dbus (send)
		bus=system
		interface=org.freedesktop.DBus.Properties,
	
	dbus (send)
		bus=system
		path=/org/freedesktop/NetworkManager
		member={state,GetDevices},
	dbus (receive)
		bus=system
		path=/org/freedesktop/NetworkManager,
	dbus (send)
		bus=system
		interface=org.freedesktop.NetworkManager.Settings
		path=/org/freedesktop/NetworkManager/Settings
		member=ListConnections,
	dbus (send)
		bus=system
		interface=org.freedesktop.NetworkManager.Settings.Connection
		path=/org/freedesktop/NetworkManager/Settings/[0-9]*
		member=GetSettings,
	dbus (receive)
		bus=system
		interface=org.freedesktop.NetworkManager.Connection.Active
		path=/org/freedesktop/NetworkManager/ActiveConnection/[0-9]*
		member=PropertiesChanged,
}
