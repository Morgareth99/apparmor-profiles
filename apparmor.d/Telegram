# vim:syntax=apparmor
# Author: Nibaldo Gonzalez <nibgonz@gmail.com>
# Last change: April 15, 2017

# NOTE: Change the Telegram binary path & the user downloads directory
# This profile is only tested on Ubuntu 16.04 & KDE Plasma 5.

#include <tunables/global>

# Downloads directory
@{DOWNLOADS_DIR}=@{HOME}/Descargas

profile Telegram /home/*/.TelegramDesktop/bin/{Telegram,Updater} {
	#include <abstractions/base>
	#include <abstractions/fonts>
	#include <abstractions/nameservice>
	#include <abstractions/kde>
	#include <abstractions/gnome>
	#include <abstractions/X>
	#include <abstractions/audio>
	#include <abstractions/dbus-strict>
	#include <abstractions/dbus-session>
	#include <abstractions/dbus-accessibility-strict>
	#include <abstractions/ibus>
	
	# Needed to open links (only for some browsers).
	#include <abstractions/open-browser>
	
	# Block full access to sensitive data, as passwords and keys.
	# Includes /boot/**, /var/log/** & /etc/apparmor.d/** directories. View in: tunables/confidential.
	deny @{CONFIDENTIAL_EXCEPT_TELEGRAM} rwklmx,
	
	owner @{HOME}/{**,} r,
	owner @{DOWNLOADS_DIR}/** rw,  # Write only in the downloads directory
	
	# Telegram directory
	owner @{HOME}/.TelegramDesktop/{**,} rwkl,
	owner @{HOME}/.TelegramDesktop/bin/* ixrwk,
	
	owner @{HOME}/.kde{,4}/share/config/kdeglobals rk,
	owner @{HOME}/.config/kdeglobals rk,
	owner @{HOME}/.config/gtk-3.0/bookmarks rw,
	owner @{HOME}/.config/dconf/user rw,
	owner /{,var/}run/user/*/dconf/user rw,
	
	deny @{HOME}/.local/share/recently-used.xbel r,
	deny /run/udev/data/{,**} rwklmx,
	deny /usr/bin/gconftool-2 x,
	deny /usr/lib*/vlc/plugins/plugins.dat.* w,
	deny /var/cache/fontconfig/ w,
	
	/usr/share/** r,
	/etc/timezone r,
	/etc/openal/alsoft.conf r,
	/etc/pulse/*.conf r,
	/etc/udev/udev.conf r,
	##/etc/machine-id r,   (In abstractions/nameservice)
	@{PROC}/[0-9]*/cmdline r,
	@{PROC}/[0-9]*/fd/{,**} r,
	/run/dbus/system_bus_socket r,
	/run/user/[0-9]*/bus r,
	/sys/dbus/** r,
	
	/dev/tty* r,
	deny /dev/video* rwmlkx,  # Block cameras
	
	# Binaries & Helpers
	/usr/bin/pulseaudio Pixr,
	/usr/bin/xdg-open ixr,
	/usr/bin/gnome-open ixr,
	/usr/bin/kde-open{,5} ixr,
	/usr/bin/gvfs-open ixr,
	/usr/bin/kdialog ixr,
	
	# Temp Files
	owner /tmp/** rwk,
	owner /var/tmp/** rw,
	
	# For Networking
	network inet stream,
	network inet6 stream,
	@{PROC}/[0-9]*/net/if_inet6 r,
	@{PROC}/[0-9]*/net/ipv6_route r,
	@{PROC}/[0-9]*/net/dev r,
	@{PROC}/[0-9]*/net/wireless r,
	
	# Dangerous Files
	audit deny owner /**/* m,        # Compiled libraries
	audit deny owner /**/*.py* r,   # Python imports
	
	ptrace (trace) peer=unconfined,
	
	dbus (send)
		bus=session
		peer=(name=org.a11y.Bus),
	dbus (receive)
		bus=session
		interface=org.a11y.atspi**,
	dbus (receive, send)
		bus=accessibility,
		
	dbus (send)
		bus=system
		interface=org.freedesktop.DBus.Property.EmitsChangedSignal,
	dbus (send)
		bus=system
		interface=org.freedesktop.DBus.Properties,
	
	dbus (send)
		bus=system
		path=/org/freedesktop/NetworkManager
		member={state,GetDevices},
	dbus (send)
		bus=system
		interface=org.freedesktop.NetworkManager.Settings
		path=/org/freedesktop/NetworkManager/Settings
		member=ListConnections,
	dbus (receive)
		bus=system
		path=/org/freedesktop/NetworkManager,
}
